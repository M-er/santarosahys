/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, HostListener } from '@angular/core';
import { MatSnackBar } from '@angular/material';
export class CuitDirective {
    /**
     * @param {?} el
     * @param {?} snackBar
     */
    constructor(el, snackBar) {
        this.el = el;
        this.snackBar = snackBar;
        // Allow decimal numbers and negative values
        this.regex = new RegExp(/^[0-9]$/g);
        // Allow key codes for special events. Reflect :
        // Backspace, tab, end, home
        this.specialKeys = ['Tab', 'End', 'Home', '-', 'ArrowLeft', 'ArrowRight'];
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onKeyDown(event) {
        if (this.specialKeys.indexOf(event.key) !== -1) {
            return;
        }
        /** @type {?} */
        const esNumero = String(event.key).match(this.regex);
        /** Si no es tecla especial o número */
        if (!esNumero && event.key !== 'Enter' && event.key !== '-' && event.key !== 'Backspace') {
            event.preventDefault();
            return;
        }
        /** @type {?} */
        const current = this.el.nativeElement.value;
        /** @type {?} */
        const next = this.el.nativeElement.value.concat(event.key);
        /**
         * Si está seleccionado, reemplazo
         * @type {?}
         */
        const seleccionado = this.el.nativeElement.selectionStart === 0 && this.el.nativeElement.selectionEnd === current.length && current.length > 0;
        if (seleccionado && esNumero) {
            event.target.value = event.key;
            event.preventDefault();
            return;
        }
        if (next.length > 13 && event.key !== 'Enter' && event.key !== 'Backspace') {
            event.preventDefault();
            return;
        }
        if (event.key === 'Backspace' && current.length > 0) {
            if (current.substring(current.length - 1, current.length) === '-') {
                event.target.value = current.substring(0, current.length - 2);
            }
            else {
                return;
            }
        }
        else if (esNumero) {
            if (next.length === 2 || next.length === 11) {
                event.target.value = current + event.key + '-';
            }
            else {
                event.target.value = current + event.key;
            }
        }
        else if (event.key === 'Enter') {
            // Debe comenzar en 20/23/27/30/33
            // Si el jj es 10 debe comenzar en 23 o 33
            /** @type {?} */
            const cuitsposibles = [20, 23, 27, 30, 33];
            /** @type {?} */
            const error = { msg: '', pos: 0 };
            /** @type {?} */
            let reto = (Number.parseInt(current.substr(10, 1), 10) * 2) + (Number.parseInt(current.substr(9, 1), 10) * 3) + (Number.parseInt(current.substr(8, 1), 10) * 4) + (Number.parseInt(current.substr(7, 1), 10) * 5);
            reto += (Number.parseInt(current.substr(6, 1), 10) * 6) + (Number.parseInt(current.substr(5, 1), 10) * 7) + (Number.parseInt(current.substr(4, 1), 10) * 2) + (Number.parseInt(current.substr(3, 1), 10) * 3);
            reto += (Number.parseInt(current.substr(1, 1), 10) * 4) + (Number.parseInt(current.substr(0, 1), 10) * 5);
            /** @type {?} */
            let jj = reto % 11;
            if (jj !== 0) {
                jj = 11 - jj;
            }
            if (current.length !== 13) {
                error.msg = 'El CUIT debe contener 13 números';
                error.pos = 13;
            }
            else if (jj === 10 || cuitsposibles.indexOf(Number(current.substr(0, 2))) === -1) {
                error.msg = 'CUIT incorrecto';
                error.pos = 0;
            }
            else if (jj !== Number.parseInt(current.substr(12, 1), 10)) {
                error.msg = 'El CUIT debería terminar en "' + jj + '"';
                error.pos = event.target.value.length - 1;
            }
            if (error.msg.length) {
                setTimeout(() => {
                    this.snackBar.open(error.msg, 'Cerrar', {
                        duration: 5 * 1000,
                        panelClass: 'snack',
                        verticalPosition: 'bottom',
                        horizontalPosition: 'start'
                    });
                    event.target.value = event.target.value.substr(0, error.pos);
                    event.target.focus();
                    event.target.selectionStart = event.target.selectionEnd = event.target.value.length;
                }, 100);
            }
        }
        event.preventDefault();
    }
}
CuitDirective.decorators = [
    { type: Directive, args: [{
                selector: '[trCuit]'
            },] }
];
/** @nocollapse */
CuitDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: MatSnackBar }
];
CuitDirective.propDecorators = {
    onKeyDown: [{ type: HostListener, args: ['keydown', ['$event'],] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.regex;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.specialKeys;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.snackBar;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VpdC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHJlcy1lcnJlcy9uZ3gtdXRpbHMvIiwic291cmNlcyI6WyJsaWIvY3VpdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFLaEQsTUFBTSxPQUFPLGFBQWE7Ozs7O0lBRXpCLFlBQ1MsRUFBYyxFQUNkLFFBQXFCO1FBRHJCLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDZCxhQUFRLEdBQVIsUUFBUSxDQUFhOztRQUl0QixVQUFLLEdBQVcsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7OztRQUl2QyxnQkFBVyxHQUFrQixDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFQeEYsQ0FBQzs7Ozs7SUFVTCxTQUFTLENBQUMsS0FBVTtRQUNuQixJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUMvQyxPQUFPO1NBQ1A7O2NBRUssUUFBUSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFcEQsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxPQUFPLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxXQUFXLEVBQUU7WUFDekYsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLE9BQU87U0FDUDs7Y0FFSyxPQUFPLEdBQUcsSUFBSSxD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Q3hCLENBQUM7OztZQWhHRCxTQUFTLFNBQUM7Z0JBQ1YsUUFBUSxFQUFFLFVBQVU7YUFDcEI7Ozs7WUFMbUIsVUFBVTtZQUNyQixXQUFXOzs7d0JBbUJsQixZQUFZLFNBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDOzs7Ozs7O0lBTm5DLDhCQUErQzs7Ozs7SUFJL0Msb0NBQTRGOzs7OztJQVQzRiwyQkFBc0I7Ozs7O0lBQ3RCLGlDQUE2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgSG9zdExpc3RlbmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXRTbmFja0JhciB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcblxuQERpcmVjdGl2ZSh7XG5cdHNlbGVjdG9yOiAnW3RyQ3VpdF0nXG59KVxuZXhwb3J0IGNsYXNzIEN1aXREaXJlY3RpdmUge1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXG5cdFx0cHJpdmF0ZSBzbmFja0JhcjogTWF0U25hY2tCYXJcblx0KSB7IH1cblxuXHQvLyBBbGxvdyBkZWNpbWFsIG51bWJlcnMgYW5kIG5lZ2F0aXZlIHZhbHVlc1xuXHRwcml2YXRlIHJlZ2V4OiBSZWdFeHAgPSBuZXcgUmVnRXhwKC9eWzAtOV0kL2cpO1xuXG5cdC8vIEFsbG93IGtleSBjb2RlcyBmb3Igc3BlY2lhbCBldmVudHMuIFJlZmxlY3QgOlxuXHQvLyBCYWNrc3BhY2UsIHRhYiwgZW5kLCBob21lXG5cdHByaXZhdGUgc3BlY2lhbEtleXM6IEFycmF5PHN0cmluZz4gPSBbJ1RhYicsICdFbmQnLCAnSG9tZScsICctJywgJ0Fycm93TGVmdCcsICdBcnJvd1JpZ2h0J107XG5cblx0QEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG5cdG9uS2V5RG93bihldmVudDogYW55KSB7XG5cdFx0aWYgKHRoaXMuc3BlY2lhbEtleXMuaW5kZXhPZihldmVudC5rZXkpICE9PSAtMSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IGVzTnVtZXJvID0gU3RyaW5nKGV2ZW50LmtleSkubWF0Y2godGhpcy5yZWdleCk7XG5cblx0XHQvKiogU2kgbm8gZXMgdGVjbGEgZXNwZWNpYWwgbyBuw7ptZXJvICovXG5cdFx0aWYgKCFlc051bWVybyAmJiBldmVudC5rZXkgIT09ICdFbnRlcicgJiYgZXZlbnQua2V5ICE9PSAnLScgJiYgZXZlbnQua2V5ICE9PSAnQmFja3NwYWNlJykge1xuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBjdXJyZW50ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnZhbHVlO1xuXHRcdGNvbnN0IG5leHQ6IHN0cmluZyA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZS5jb25jYXQoZXZlbnQua2V5KTtcblxuXHRcdC8qKiBTaSBlc3TDoSBzZWxlY2Npb25hZG8sIHJlZW1wbGF6byAqL1xuXHRcdGNvbnN0IHNlbGVjY2lvbmFkbyA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5zZWxlY3Rpb25TdGFydCA9PT0gMCAmJiB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc2VsZWN0aW9uRW5kID09PSBjdXJyZW50Lmxlbmd0aCAmJiBjdXJyZW50Lmxlbmd0aCA+IDA7XG5cdFx0aWYgKHNlbGVjY2lvbmFkbyAmJiBlc051bWVybykge1xuXHRcdFx0ZXZlbnQudGFyZ2V0LnZhbHVlID0gZXZlbnQua2V5O1xuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAobmV4dC5sZW5ndGggPiAxMyAmJiBldmVudC5rZXkgIT09ICdFbnRlcicgJiYgZXZlbnQua2V5ICE9PSAnQmFja3NwYWNlJykge1xuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoZXZlbnQua2V5ID09PSAnQmFja3NwYWNlJyAmJiBjdXJyZW50Lmxlbmd0aCA+IDApIHtcblx0XHRcdGlmIChjdXJyZW50LnN1YnN0cmluZyhjdXJyZW50Lmxlbmd0aCAtIDEsIGN1cnJlbnQubGVuZ3RoKSA9PT0gJy0nKSB7XG5cdFx0XHRcdGV2ZW50LnRhcmdldC52YWx1ZSA9IGN1cnJlbnQuc3Vic3RyaW5nKDAsIGN1cnJlbnQubGVuZ3RoIC0gMik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChlc051bWVybykge1xuXHRcdFx0aWYgKG5leHQubGVuZ3RoID09PSAyIHx8IG5leHQubGVuZ3RoID09PSAxMSkge1xuXHRcdFx0XHRldmVudC50YXJnZXQudmFsdWUgPSBjdXJyZW50ICsgZXZlbnQua2V5ICsgJy0nO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZXZlbnQudGFyZ2V0LnZhbHVlID0gY3VycmVudCArIGV2ZW50LmtleTtcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gJ0VudGVyJykge1xuXHRcdFx0Ly8gRGViZSBjb21lbnphciBlbiAyMC8yMy8yNy8zMC8zM1xuXHRcdFx0Ly8gU2kgZWwgamogZXMgMTAgZGViZSBjb21lbnphciBlbiAyMyBvIDMzXG5cdFx0XHRjb25zdCBjdWl0c3Bvc2libGVzID0gWzIwLCAyMywgMjcsIDMwLCAzM107XG5cdFx0XHRjb25zdCBlcnJvciA9IHsgbXNnOiAnJywgcG9zOiAwIH07XG5cdFx0XHRsZXQgcmV0byA9IChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoMTAsIDEpLCAxMCkgKiAyKSArIChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoOSwgMSksIDEwKSAqIDMpICsgKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cig4LCAxKSwgMTApICogNCkgKyAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDcsIDEpLCAxMCkgKiA1KTtcblx0XHRcdHJldG8gKz0gKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cig2LCAxKSwgMTApICogNikgKyAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDUsIDEpLCAxMCkgKiA3KSArIChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoNCwgMSksIDEwKSAqIDIpICsgKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cigzLCAxKSwgMTApICogMyk7XG5cdFx0XHRyZXRvICs9IChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoMSwgMSksIDEwKSAqIDQpICsgKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cigwLCAxKSwgMTApICogNSk7XG5cdFx0XHRsZXQgamogPSByZXRvICUgMTE7XG5cdFx0XHRpZiAoamogIT09IDApIHtcblx0XHRcdFx0amogPSAxMSAtIGpqO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGN1cnJlbnQubGVuZ3RoICE9PSAxMykge1xuXHRcdFx0XHRlcnJvci5tc2cgPSAnRWwgQ1VJVCBkZWJlIGNvbnRlbmVyIDEzIG7Dum1lcm9zJztcblx0XHRcdFx0ZXJyb3IucG9zID0gMTM7XG5cdFx0XHR9IGVsc2UgaWYgKGpqID09PSAxMCB8fCBjdWl0c3Bvc2libGVzLmluZGV4T2YoTnVtYmVyKGN1cnJlbnQuc3Vic3RyKDAsIDIpKSkgPT09IC0xKSB7XG5cdFx0XHRcdGVycm9yLm1zZyA9ICdDVUlUIGluY29ycmVjdG8nO1xuXHRcdFx0XHRlcnJvci5wb3MgPSAwO1xuXHRcdFx0fSBlbHNlIGlmIChqaiAhPT0gTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDEyLCAxKSwgMTApKSB7XG5cdFx0XHRcdGVycm9yLm1zZyA9ICdFbCBDVUlUIGRlYmVyw61hIHRlcm1pbmFyIGVuIFwiJyArIGpqICsgJ1wiJztcblx0XHRcdFx0ZXJyb3IucG9zID0gZXZlbnQudGFyZ2V0LnZhbHVlLmxlbmd0aCAtIDE7XG5cdFx0XHR9XG5cdFx0XHRpZiAoZXJyb3IubXNnLmxlbmd0aCkge1xuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHR0aGlzLnNuYWNrQmFyLm9wZW4oZXJyb3IubXNnLCAnQ2VycmFyJywge1xuXHRcdFx0XHRcdFx0ZHVyYXRpb246IDUgKiAxMDAwLFxuXHRcdFx0XHRcdFx0cGFuZWxDbGFzczogJ3NuYWNrJyxcblx0XHRcdFx0XHRcdHZlcnRpY2FsUG9zaXRpb246ICdib3R0b20nLFxuXHRcdFx0XHRcdFx0aG9yaXpvbnRhbFBvc2l0aW9uOiAnc3RhcnQnXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0ZXZlbnQudGFyZ2V0LnZhbHVlID0gZXZlbnQudGFyZ2V0LnZhbHVlLnN1YnN0cigwLCBlcnJvci5wb3MpO1xuXHRcdFx0XHRcdGV2ZW50LnRhcmdldC5mb2N1cygpO1xuXHRcdFx0XHRcdGV2ZW50LnRhcmdldC5zZWxlY3Rpb25TdGFydCA9IGV2ZW50LnRhcmdldC5zZWxlY3Rpb25FbmQgPSBldmVudC50YXJnZXQudmFsdWUubGVuZ3RoO1xuXHRcdFx0XHR9LCAxMDApO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHR9XG5cbn1cbiJdfQ==
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, HostListener } from '@angular/core';
import { MatSnackBar } from '@angular/material';
var CuitDirective = /** @class */ (function () {
    function CuitDirective(el, snackBar) {
        this.el = el;
        this.snackBar = snackBar;
        // Allow decimal numbers and negative values
        this.regex = new RegExp(/^[0-9]$/g);
        // Allow key codes for special events. Reflect :
        // Backspace, tab, end, home
        this.specialKeys = ['Tab', 'End', 'Home', '-', 'ArrowLeft', 'ArrowRight'];
    }
    /**
     * @param {?} event
     * @return {?}
     */
    CuitDirective.prototype.onKeyDown = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        if (this.specialKeys.indexOf(event.key) !== -1) {
            return;
        }
        /** @type {?} */
        var esNumero = String(event.key).match(this.regex);
        /** Si no es tecla especial o número */
        if (!esNumero && event.key !== 'Enter' && event.key !== '-' && event.key !== 'Backspace') {
            event.preventDefault();
            return;
        }
        /** @type {?} */
        var current = this.el.nativeElement.value;
        /** @type {?} */
        var next = this.el.nativeElement.value.concat(event.key);
        /**
         * Si está seleccionado, reemplazo
         * @type {?}
         */
        var seleccionado = this.el.nativeElement.selectionStart === 0 && this.el.nativeElement.selectionEnd === current.length && current.length > 0;
        if (seleccionado && esNumero) {
            event.target.value = event.key;
            event.preventDefault();
            return;
        }
        if (next.length > 13 && event.key !== 'Enter' && event.key !== 'Backspace') {
            event.preventDefault();
            return;
        }
        if (event.key === 'Backspace' && current.length > 0) {
            if (current.substring(current.length - 1, current.length) === '-') {
                event.target.value = current.substring(0, current.length - 2);
            }
            else {
                return;
            }
        }
        else if (esNumero) {
            if (next.length === 2 || next.length === 11) {
                event.target.value = current + event.key + '-';
            }
            else {
                event.target.value = current + event.key;
            }
        }
        else if (event.key === 'Enter') {
            // Debe comenzar en 20/23/27/30/33
            // Si el jj es 10 debe comenzar en 23 o 33
            /** @type {?} */
            var cuitsposibles = [20, 23, 27, 30, 33];
            /** @type {?} */
            var error_1 = { msg: '', pos: 0 };
            /** @type {?} */
            var reto = (Number.parseInt(current.substr(10, 1), 10) * 2) + (Number.parseInt(current.substr(9, 1), 10) * 3) + (Number.parseInt(current.substr(8, 1), 10) * 4) + (Number.parseInt(current.substr(7, 1), 10) * 5);
            reto += (Number.parseInt(current.substr(6, 1), 10) * 6) + (Number.parseInt(current.substr(5, 1), 10) * 7) + (Number.parseInt(current.substr(4, 1), 10) * 2) + (Number.parseInt(current.substr(3, 1), 10) * 3);
            reto += (Number.parseInt(current.substr(1, 1), 10) * 4) + (Number.parseInt(current.substr(0, 1), 10) * 5);
            /** @type {?} */
            var jj = reto % 11;
            if (jj !== 0) {
                jj = 11 - jj;
            }
            if (current.length !== 13) {
                error_1.msg = 'El CUIT debe contener 13 números';
                error_1.pos = 13;
            }
            else if (jj === 10 || cuitsposibles.indexOf(Number(current.substr(0, 2))) === -1) {
                error_1.msg = 'CUIT incorrecto';
                error_1.pos = 0;
            }
            else if (jj !== Number.parseInt(current.substr(12, 1), 10)) {
                error_1.msg = 'El CUIT debería terminar en "' + jj + '"';
                error_1.pos = event.target.value.length - 1;
            }
            if (error_1.msg.length) {
                setTimeout(function () {
                    _this.snackBar.open(error_1.msg, 'Cerrar', {
                        duration: 5 * 1000,
                        panelClass: 'snack',
                        verticalPosition: 'bottom',
                        horizontalPosition: 'start'
                    });
                    event.target.value = event.target.value.substr(0, error_1.pos);
                    event.target.focus();
                    event.target.selectionStart = event.target.selectionEnd = event.target.value.length;
                }, 100);
            }
        }
        event.preventDefault();
    };
    CuitDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[trCuit]'
                },] }
    ];
    /** @nocollapse */
    CuitDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: MatSnackBar }
    ]; };
    CuitDirective.propDecorators = {
        onKeyDown: [{ type: HostListener, args: ['keydown', ['$event'],] }]
    };
    return CuitDirective;
}());
export { CuitDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.regex;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.specialKeys;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    CuitDirective.prototype.snackBar;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VpdC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHJlcy1lcnJlcy9uZ3gtdXRpbHMvIiwic291cmNlcyI6WyJsaWIvY3VpdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFaEQ7SUFLQyx1QkFDUyxFQUFjLEVBQ2QsUUFBcUI7UUFEckIsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLGFBQVEsR0FBUixRQUFRLENBQWE7O1FBSXRCLFVBQUssR0FBVyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQzs7O1FBSXZDLGdCQUFXLEdBQWtCLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztJQVB4RixDQUFDOzs7OztJQVVMLGlDQUFTOzs7O0lBRFQsVUFDVSxLQUFVO1FBRHBCLGlCQStFQztRQTdFQSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUMvQyxPQUFPO1NBQ1A7O1lBRUssUUFBUSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFcEQsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxPQUFPLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsS0FBSyxXQUFXLEVBQUU7WUFDekYsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLE9BQU87U0FDUDs7WUFFSyxPQUFPLEdBQUcsSUFB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Qzs7Z0JBaEdELFNBQVMsU0FBQztvQkFDVixRQUFRLEVBQUUsVUFBVTtpQkFDcEI7Ozs7Z0JBTG1CLFVBQVU7Z0JBQ3JCLFdBQVc7Ozs0QkFtQmxCLFlBQVksU0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBaUZwQyxvQkFBQztDQUFBLEFBbEdELElBa0dDO1NBL0ZZLGFBQWE7Ozs7OztJQVF6Qiw4QkFBK0M7Ozs7O0lBSS9DLG9DQUE0Rjs7Ozs7SUFUM0YsMkJBQXNCOzs7OztJQUN0QixpQ0FBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEhvc3RMaXN0ZW5lciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWF0U25hY2tCYXIgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5cbkBEaXJlY3RpdmUoe1xuXHRzZWxlY3RvcjogJ1t0ckN1aXRdJ1xufSlcbmV4cG9ydCBjbGFzcyBDdWl0RGlyZWN0aXZlIHtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuXHRcdHByaXZhdGUgc25hY2tCYXI6IE1hdFNuYWNrQmFyXG5cdCkgeyB9XG5cblx0Ly8gQWxsb3cgZGVjaW1hbCBudW1iZXJzIGFuZCBuZWdhdGl2ZSB2YWx1ZXNcblx0cHJpdmF0ZSByZWdleDogUmVnRXhwID0gbmV3IFJlZ0V4cCgvXlswLTldJC9nKTtcblxuXHQvLyBBbGxvdyBrZXkgY29kZXMgZm9yIHNwZWNpYWwgZXZlbnRzLiBSZWZsZWN0IDpcblx0Ly8gQmFja3NwYWNlLCB0YWIsIGVuZCwgaG9tZVxuXHRwcml2YXRlIHNwZWNpYWxLZXlzOiBBcnJheTxzdHJpbmc+ID0gWydUYWInLCAnRW5kJywgJ0hvbWUnLCAnLScsICdBcnJvd0xlZnQnLCAnQXJyb3dSaWdodCddO1xuXG5cdEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuXHRvbktleURvd24oZXZlbnQ6IGFueSkge1xuXHRcdGlmICh0aGlzLnNwZWNpYWxLZXlzLmluZGV4T2YoZXZlbnQua2V5KSAhPT0gLTEpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBlc051bWVybyA9IFN0cmluZyhldmVudC5rZXkpLm1hdGNoKHRoaXMucmVnZXgpO1xuXG5cdFx0LyoqIFNpIG5vIGVzIHRlY2xhIGVzcGVjaWFsIG8gbsO6bWVybyAqL1xuXHRcdGlmICghZXNOdW1lcm8gJiYgZXZlbnQua2V5ICE9PSAnRW50ZXInICYmIGV2ZW50LmtleSAhPT0gJy0nICYmIGV2ZW50LmtleSAhPT0gJ0JhY2tzcGFjZScpIHtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgY3VycmVudCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZTtcblx0XHRjb25zdCBuZXh0OiBzdHJpbmcgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudmFsdWUuY29uY2F0KGV2ZW50LmtleSk7XG5cblx0XHQvKiogU2kgZXN0w6Egc2VsZWNjaW9uYWRvLCByZWVtcGxhem8gKi9cblx0XHRjb25zdCBzZWxlY2Npb25hZG8gPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc2VsZWN0aW9uU3RhcnQgPT09IDAgJiYgdGhpcy5lbC5uYXRpdmVFbGVtZW50LnNlbGVjdGlvbkVuZCA9PT0gY3VycmVudC5sZW5ndGggJiYgY3VycmVudC5sZW5ndGggPiAwO1xuXHRcdGlmIChzZWxlY2Npb25hZG8gJiYgZXNOdW1lcm8pIHtcblx0XHRcdGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LmtleTtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKG5leHQubGVuZ3RoID4gMTMgJiYgZXZlbnQua2V5ICE9PSAnRW50ZXInICYmIGV2ZW50LmtleSAhPT0gJ0JhY2tzcGFjZScpIHtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKGV2ZW50LmtleSA9PT0gJ0JhY2tzcGFjZScgJiYgY3VycmVudC5sZW5ndGggPiAwKSB7XG5cdFx0XHRpZiAoY3VycmVudC5zdWJzdHJpbmcoY3VycmVudC5sZW5ndGggLSAxLCBjdXJyZW50Lmxlbmd0aCkgPT09ICctJykge1xuXHRcdFx0XHRldmVudC50YXJnZXQudmFsdWUgPSBjdXJyZW50LnN1YnN0cmluZygwLCBjdXJyZW50Lmxlbmd0aCAtIDIpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAoZXNOdW1lcm8pIHtcblx0XHRcdGlmIChuZXh0Lmxlbmd0aCA9PT0gMiB8fCBuZXh0Lmxlbmd0aCA9PT0gMTEpIHtcblx0XHRcdFx0ZXZlbnQudGFyZ2V0LnZhbHVlID0gY3VycmVudCArIGV2ZW50LmtleSArICctJztcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGV2ZW50LnRhcmdldC52YWx1ZSA9IGN1cnJlbnQgKyBldmVudC5rZXk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChldmVudC5rZXkgPT09ICdFbnRlcicpIHtcblx0XHRcdC8vIERlYmUgY29tZW56YXIgZW4gMjAvMjMvMjcvMzAvMzNcblx0XHRcdC8vIFNpIGVsIGpqIGVzIDEwIGRlYmUgY29tZW56YXIgZW4gMjMgbyAzM1xuXHRcdFx0Y29uc3QgY3VpdHNwb3NpYmxlcyA9IFsyMCwgMjMsIDI3LCAzMCwgMzNdO1xuXHRcdFx0Y29uc3QgZXJyb3IgPSB7IG1zZzogJycsIHBvczogMCB9O1xuXHRcdFx0bGV0IHJldG8gPSAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDEwLCAxKSwgMTApICogMikgKyAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDksIDEpLCAxMCkgKiAzKSArIChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoOCwgMSksIDEwKSAqIDQpICsgKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cig3LCAxKSwgMTApICogNSk7XG5cdFx0XHRyZXRvICs9IChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoNiwgMSksIDEwKSAqIDYpICsgKE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cig1LCAxKSwgMTApICogNykgKyAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDQsIDEpLCAxMCkgKiAyKSArIChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoMywgMSksIDEwKSAqIDMpO1xuXHRcdFx0cmV0byArPSAoTnVtYmVyLnBhcnNlSW50KGN1cnJlbnQuc3Vic3RyKDEsIDEpLCAxMCkgKiA0KSArIChOdW1iZXIucGFyc2VJbnQoY3VycmVudC5zdWJzdHIoMCwgMSksIDEwKSAqIDUpO1xuXHRcdFx0bGV0IGpqID0gcmV0byAlIDExO1xuXHRcdFx0aWYgKGpqICE9PSAwKSB7XG5cdFx0XHRcdGpqID0gMTEgLSBqajtcblx0XHRcdH1cblx0XHRcdGlmIChjdXJyZW50Lmxlbmd0aCAhPT0gMTMpIHtcblx0XHRcdFx0ZXJyb3IubXNnID0gJ0VsIENVSVQgZGViZSBjb250ZW5lciAxMyBuw7ptZXJvcyc7XG5cdFx0XHRcdGVycm9yLnBvcyA9IDEzO1xuXHRcdFx0fSBlbHNlIGlmIChqaiA9PT0gMTAgfHwgY3VpdHNwb3NpYmxlcy5pbmRleE9mKE51bWJlcihjdXJyZW50LnN1YnN0cigwLCAyKSkpID09PSAtMSkge1xuXHRcdFx0XHRlcnJvci5tc2cgPSAnQ1VJVCBpbmNvcnJlY3RvJztcblx0XHRcdFx0ZXJyb3IucG9zID0gMDtcblx0XHRcdH0gZWxzZSBpZiAoamogIT09IE51bWJlci5wYXJzZUludChjdXJyZW50LnN1YnN0cigxMiwgMSksIDEwKSkge1xuXHRcdFx0XHRlcnJvci5tc2cgPSAnRWwgQ1VJVCBkZWJlcsOtYSB0ZXJtaW5hciBlbiBcIicgKyBqaiArICdcIic7XG5cdFx0XHRcdGVycm9yLnBvcyA9IGV2ZW50LnRhcmdldC52YWx1ZS5sZW5ndGggLSAxO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGVycm9yLm1zZy5sZW5ndGgpIHtcblx0XHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5zbmFja0Jhci5vcGVuKGVycm9yLm1zZywgJ0NlcnJhcicsIHtcblx0XHRcdFx0XHRcdGR1cmF0aW9uOiA1ICogMTAwMCxcblx0XHRcdFx0XHRcdHBhbmVsQ2xhc3M6ICdzbmFjaycsXG5cdFx0XHRcdFx0XHR2ZXJ0aWNhbFBvc2l0aW9uOiAnYm90dG9tJyxcblx0XHRcdFx0XHRcdGhvcml6b250YWxQb3NpdGlvbjogJ3N0YXJ0J1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LnRhcmdldC52YWx1ZS5zdWJzdHIoMCwgZXJyb3IucG9zKTtcblx0XHRcdFx0XHRldmVudC50YXJnZXQuZm9jdXMoKTtcblx0XHRcdFx0XHRldmVudC50YXJnZXQuc2VsZWN0aW9uU3RhcnQgPSBldmVudC50YXJnZXQuc2VsZWN0aW9uRW5kID0gZXZlbnQudGFyZ2V0LnZhbHVlLmxlbmd0aDtcblx0XHRcdFx0fSwgMTAwKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0fVxuXG59XG4iXX0=